<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>DFP for GTM normal-page or infinite-page</title>
    <style>
        .makAd iframe {
            background-color: #faa;
        }
    </style>
</head>

<body>
    <div id="AdUnit">
        <div id="one">123</div>
        <div id="two">456</div>
        <div id="three">789</div>
    </div>

    <!-- Original Code
[head]
    <script async='async' src='https://www.googletagservices.com/tag/js/gpt.js'></script>
    <script>
      var googletag = googletag || {};
      googletag.cmd = googletag.cmd || [];
    </script>
  
    <script>
      googletag.cmd.push(function() {
        var mapping1 = googletag.sizeMapping().
                addSize([980, 0], [970, 250]). // 電腦
                addSize([480, 0], [336, 280]). // mobile
                addSize([0, 0], [300, 250]).
            build();
        googletag.defineSlot('/19597162/info_336280_1', [300, 250], 'div-gpt-ad-1531896988226-8').defineSizeMapping(mapping1).addService(googletag.pubads());
        googletag.pubads().enableSingleRequest();
        googletag.pubads().collapseEmptyDivs();
        googletag.enableServices();
      });
    </script>
 [body]
    <div id="DFP-index_rightSideBarFirst_336280" class="makAd widget" style="margin: 0 0 20px;text-align: center; text-align:-webkit-center;">
        <div id='div-gpt-ad-1531896988226-8'>
        <script>
            googletag.cmd.push(function() { googletag.display('div-gpt-ad-1531896988226-8'); });
        </script>
        </div>
    </div>
  -->

    <script>
        /// ========== 廣告區塊資訊 (Main Object) ========== ///
        let adsBlock = [{
            note: '[首頁] 右側欄第一則 336*280 廣告', // 無作用欄位 類似註解 方便查詢 (自訂)
            divid: 'index_rightSideBarFirst_336280', // 廣告區塊 id 名稱 （自訂）
            divclass: 'makAd widget', //廣告區塊 class 名稱 （自訂）
            defslot: '/19597162/info_336280_1', // DFP adUnit name （DFP）
            id: 'div-gpt-ad-1531896988226-8', // DFP adUnit id （DFP）
            size: [300, 250], // DFP adUnit Size -> exp. one size [336, 280], two size [[336, 280], [300, 250]]... (DFP)
            mapping: '', // If RWD? [mapping array] : '' ; => ( [[[980, 0],[970, 250]],[[480, 0],[336, 280]], [[0,0], [300, 250]]] ) (DFP)
            dom: '#one', // 廣告要 pendDOM 位置 （自訂）
            place: 'before', // after, before, html, append, prepend （自訂）
            stycss: 'margin: 0 0 20px;text-align: center; text-align:-webkit-center;' // CSS （自訂）
        }, {
            note: '[首頁] 右側欄第2則 336*280 廣告', // 無作用欄位 類似註解 方便查詢
            divid: 'index_rightSideBarFirst_336280', // 廣告區塊 id 名稱
            divclass: 'makAd widget', //廣告區塊 class 名稱
            defslot: '/19597162/info_336280_2', // DFP adUnit name
            id: 'div-gpt-ad-1531896988226-9', // DFP adUnit id
            size: [336, 280], // DFP adUnit Size -> exp. one size [336, 280], two size [[336, 280], [300, 250]]...
            mapping: '', // If RWD? [mapping array] : ''
            dom: '#two', // 廣告要 pendDOM 位置
            place: 'after', // after, before, html, append, prepend
            stycss: 'margin: 0 0 20px;text-align: center; text-align:-webkit-center;' // CSS
        }];

        const MainFunction = ((w, adsBlock) => {
            /// ========== [ Create DFP head defineSlot Lib ] ========== ///

            /*---------- create DFP lib gpt.js ----------*/
            let s1 = document.createElement("script");
            s1.type = "text/javascript";
            s1.async = true;
            s1.src = "https://www.googletagservices.com/tag/js/gpt.js";
            document.head.appendChild(s1);

            /*---------- create googletag.cmd ----------*/
            let s2 = document.createElement("script");
            s2.innerHTML = 'var googletag = googletag || {};googletag.cmd = googletag.cmd || [];';
            document.head.appendChild(s2);

            /// ========== [ create googletag.cmd.push] ========== ///
            googletag.cmd.push(function() {
                for (let B of adsBlock) {
                    let adsMainDef = googletag.defineSlot(B.defslot, B.size, B.id);
                    let adsUnMapping = adsMainDef.addService(googletag.pubads());
                    let adsMapping = adsMainDef.defineSizeMapping(B.mapping).addService(googletag.pubads());

                    B.mapping == '' ? adsUnMapping : adsMapping;
                }
                /// ========== [ DFP event ] ========== ///
                /*googletag.pubads().addEventListener('slotRenderEnded', function(event) {
                    //console.log('DFP Event:' + event.slot.getSlotElementId());
                    if (event.slot.getSlotElementId() == 'div-gpt-ad-1513767903209-4') {
                        if (!event.isEmpty) { //如果 DFP 版位 不為 空版
                            console.log('adUnit not Empty');
                        }else{
                            console.log('adUnit is Empty');
                        }
                    }
                }); */
                googletag.pubads().enableSingleRequest();
                googletag.pubads().collapseEmptyDivs();
                googletag.enableServices();
            });

            /// ========== [ Start Publish_AdCode_DFP main ] ========== ///
            let DFPTasks = [];
            let isContain = (node, checkNodes) => {
                let isExit = false;
                for (let i = 0, iz = checkNodes.length; i < iz; i++) {
                    if (node === checkNodes[i]) {
                        isExit = true;
                        break;
                    }
                }
                return isExit;
            };
            let setAdBody = (divId, divClass, styCss, id) => {

                /* ---------- create Outer divDom ---------- */
                let AdBody = document.createElement('DIV');
                AdBody.id = `DFP-${divId}`;
                AdBody.className = divClass;
                AdBody.style = styCss;

                /* ---------- create Inner divDom ---------- */
                let AdBodyInnerDiv = document.createElement('DIV');
                AdBodyInnerDiv.id = id;

                /* ---------- create Inner script ---------- */
                let AdBodyInnerScript = document.createElement('SCRIPT');
                AdBodyInnerScript.text = `googletag.cmd.push(function() {googletag.display('${id}');});`

                /* ---------- append Inner Dom & script ---------- */
                AdBodyInnerDiv.appendChild(AdBodyInnerScript);
                AdBody.appendChild(AdBodyInnerDiv);

                return AdBody;
            };
            /* ---------- [ Create init function ] ---------- */

            let initDFP = (AdDom, AdBody, place) => {
                switch (place) {
                    case 'before':
                        AdDom.parentNode.insertBefore(AdBody, AdDom);
                        break;
                    case 'after':
                        AdDom.parentNode.insertBefore(AdBody, AdDom.nextSibling);
                        break;
                    case 'html':
                        while (AdDom.firstChild) AdDom.removeChild(AdDom.firstChild);
                        AdDom.appendChild(AdBody);
                        break;
                    case 'append':
                        AdDom.appendChild(AdBody);
                        break;
                    case 'prepend':
                        AdDom.insertBefore(AdBody, AdDom.firstChild);
                        break;
                }
            };

            for (let [index, B] of adsBlock.entries()) {
                class DFPGroup {
                    constructor() {
                        this.containers = [];
                    }
                    checkDev() {
                        let IntervalID = window.setInterval(() => {
                            let nodes = document.querySelectorAll(B.dom);
                            for (let i = 0, iz = nodes.length; i < iz; i++) {
                                let node = nodes[i];
                                if (!isContain(node, this.containers)) {
                                    this.containers.push(node);
                                    let AdBody = setAdBody(B.divid, B.divclass, B.stycss, B.id);
                                    initDFP(node, AdBody, B.place);
                                }
                            }
                        }, 500);
                    }
                };
                DFPTasks[index] = new DFPGroup();
                DFPTasks[index].checkDev();
            };
            window.DFPTasks = DFPTasks;

        })(window, adsBlock);
    </script>
</body>

</html>